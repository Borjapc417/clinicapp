{% include "navbar.html" %}

    {% block body %}
    <section class="vh-100">
        <div class="container py-5 h-100">
          <div class="row justify-content-center align-items-center h-100">
            <div class="col-12 col-lg-9 col-xl-7">
              <div class="card shadow-2-strong card-registration" style="border-radius: 15px;">
                <div class="card-body p-4 p-md-5">
                  <h3 class="mb-4 pb-2 pb-md-0 mb-md-5">
                    {% if cita.id > 0 %}
                      Editar cita
                    {% else %}
                      Añadir nueva Cita
                    {% endif %}
                  </h3>

                  {% if messages|length > 0 %}
                  {% for message in messages %}
                <div class="alert alert-danger" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}

                <form method="post" id="form"
                {% if cita.id > 0 %}
                  action="/cita/update/{{ cita.id }}"
                {% else %}
                  action="/cita/add"
                {% endif %}
                >
                    {% csrf_token %}


                    <div class="row">
                        <div class="col-md-6 mb-4">      
                          <div class="form-outline">
                            <input type="text" id="nombre" class="form-control form-control-lg" name="nombre" value="{{ cita.nombre }}">
                            <label class="form-label" for="nombre">Nombre</label>
                          </div>
                        </div>
  
                        <div class="col-md-6 mb-4">
                          <div class="form-outline">
                            <input type="text" id="apellidos" class="form-control form-control-lg" name="apellidos" value="{{ cita.apellidos }}">
                            <label class="form-label" for="apellidos">Apellidos</label>
                          </div>
                        </div>
  
                      </div>
  
  

                    <div class="row">
                      <div class="col-md-6 mb-4">
      
                        <div class="form-outline">
                          <input type="text" id="telefono" class="form-control form-control-lg" name="telefono" value="{{ cita.telefono }}">
                          <label class="form-label" for="telefono">Telefono</label>
                        </div>
      
                      </div>
                      <div class="col-md-6 mb-4">
      
                        <div class="form-outline">
                            <select class="form-control form-control-lg" id="motivo" name="motivo" value="{{ cita.motivo }}">
                                    <option value="INFORMACION"
                                    {% if cita.motivo == "INFORMACION" %}
                                      selected
                                    {% endif %}
                                    >INFORMACION</option>

                                    <option value="MEDICINA FAMILIAR"
                                    {% if cita.motivo == "MEDICINA FAMILIAR" %}
                                      selected
                                    {% endif %}
                                    >MEDICINA FAMILIAR</option>

                                    <option value="CONSULTA"
                                    {% if cita.motivo == "CONSULTA" %}
                                      selected
                                    {% endif %}
                                    >CONSULTA</option>

                                    <option value="REVISION"
                                    {% if cita.motivo == "REVISION" %}
                                      selected
                                    {% endif %}
                                    >REVISION</option>
                            </select>                          
                                <label class="form-label" for="motivo">Motivo</label>
                        </div>
      
                      </div>

                    </div>

                    
                    <div class="row">
                        <div class="col-md-6 mb-4">      
                          <div class="form-outline">
                            <input type="date" id="fecha" class="form-control form-control-lg" name="fecha" value="{{ cita.fecha_programada |date:"Y-m-d" }}">
                            <label class="form-label" for="fecha">Fecha</label>
                          </div>
                        </div>
                        <div class="col-md-6 mb-4">
                          <div class="form-outline">
                            <select type="text" id="hora" class="form-control form-control-lg" name="hora">

                            </select>
                            <label class="form-label" for="hora">Hora</label>
                          </div>
                        </div>
  
                      </div>


                    <div class="alert alert-info" role="alert" id="hora_disponible" style="display: none;">

                    </div>

                    <script>
                        

                            document.getElementById("fecha").addEventListener("change", insertarFechas);    
                            function insertarFechas(){     
                                select = document.getElementById('hora');
                                select.innerHTML = '';                   
                                consulta = $("#fecha").val();
                                $.ajax({
                                data: {'fecha': consulta},
                                url: '/cita/horas/',
                                type: 'get',
                                success : function(data) {
                                        for (let i = 0; i < data.length; i++) {
                                            var value = data[i].substring(11, 16);
                                            var opt = document.createElement('option');
                                            opt.value = value;
                                            opt.innerHTML = value;
                                            select.appendChild(opt);
                                        }                                       
                                },
                                error : function(message) {
                                        console.log(message);
                                    }
                                });
   
                        }

                        {% if cita.id > 0  %}
                          var hora = "{{ cita.fecha_programada |date:"H:i" }}";
                          insertarFechas();
                          select = document.getElementById('hora');
                          var opt = document.createElement('option');
                          opt.value = hora;
                          opt.innerHTML = hora;
                          opt.id = hora;
                          optionHora = document.getElementById("hora").setAttribute("selected", "selected");
                          select.appendChild(opt);

                        {% endif %}

                    
                    </script>

                    <div class="row">
                      <div class="col">      
                        <div class="form-outline">
                          <select id="duracion" class="form-control form-control-lg" name="duracion">
                            {% for d in duraciones %}
                              <option
                                {% if d == cita.duracion %}
                                selected> 
                                {% else %}
                                >
                                {% endif %}
                                {{ d }} 
                              </option>                            
                            {% endfor %}
                          </select>
                          <label class="form-label" for="duracion">Duraciones</label>
                        </div>
                      </div>
                    </div>
                    {% if cita.id_paciente != None %}
                      <div id="div_paciente">
                        <div class="row">
                          <div class="col d-flex align-items-center">
                            <input type="input" list="datalist" autocomplete="off" class="form-control form-control-lg" id="paciente" name="paciente" value="{{cita.id_paciente.dni}}: {{cita.id_paciente.nombre}}, {{ cita.id_paciente.apellidos }} -- {{ cita.id_paciente.telefono }} -- {{ cita.id_paciente.dni }} -- {{ cita.id_paciente.email }}"/>
                            <datalist id="datalist">
                              {% for item in pacientes %}
                                <option>{{item.dni}}: {{item.nombre}}, {{ item.apellidos }} -- {{ item.telefono }} -- {{ item.dni }} -- {{ item.email }}</option>
                              {% endfor %}
                            </datalist>
    
                          </div>
                        </div>
                        <div class="row">
                          <label id="intervencion_label" for="intervencion" class="form-label">Paciente</label>
                        </div>
                        </div>
                    {% else %}
                        <div id="div_paciente" style="display: none;">
                          <div class="row">
                            <div class="col d-flex align-items-center">
                              <input type="input" list="datalist" autocomplete="off" class="form-control form-control-lg" id="paciente" name="paciente"/>
                              <datalist id="datalist">
                                {% for item in pacientes %}
                                  <option>{{item.dni}}: {{item.nombre}}, {{ item.apellidos }} -- {{ item.telefono }} -- {{ item.dni }} -- {{ item.email }}</option>
                                {% endfor %}
                              </datalist>

                            </div>
                          </div>
                          <div class="row">
                            <label id="intervencion_label" for="intervencion" class="form-label">Paciente</label>
                          </div>
                          </div>
                    {% endif %}

                    

                    <script>
                      let nombre = document.getElementById("nombre");
                      nombre.addEventListener("change", verPacientes);
                      let apellidos = document.getElementById("apellidos");
                      apellidos.addEventListener("change", verPacientes);
                      let telefono = document.getElementById("telefono");
                      telefono.addEventListener("change", verPacientes);

                      function verPacientes(){
                        if(nombre.value != "" && apellidos.value != "" && telefono.value != ""){
                          var texto = nombre.value.toUpperCase() + ", " + apellidos.value.toUpperCase() + " -- " + telefono.value;

                          var options = document.querySelectorAll("#datalist option");
                          var similarOptions = Array.from(options).filter(function(option) {
                            return option.text.toUpperCase().includes(texto.toUpperCase());
                          });

                          if(similarOptions.length > 0){
                            document.getElementById("paciente").value = texto;
                            document.getElementById("div_paciente").style.display ="block";

                          } else {
                            document.getElementById("paciente").value = ""; 
                            document.getElementById("div_paciente").style.display ="none";
                          }
                        }else{
                          document.getElementById("div_paciente").style.display ="none";
                          document.getElementById("paciente").value = ""; 
                        }
                      }
                  
                    </script>

                      
                    <div class="mt-4 pt-2">
                      <input class="btn btn-primary btn-lg" type="submit" value="Guardar" style="border-radius: 2rem;"/>
                    </div>
      
                  </form>

                  <script>

                    var form = document.getElementById("form");
                    form.addEventListener("submit", function(event) {
                      if( document.getElementById("paciente").value == ""){
                        if (!confirm("La cita no tiene paciente, ¿desea continuar?")) {
                          event.preventDefault();
                        }
                      }
                    });
                  </script>


                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {% endblock %}